<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Testing document</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css" />
  <link rel="stylesheet" href="/css/style.css" />
</head>

<body>
  <h1>Testing</h1>
  <div class="w-11/12 mx-auto mt-2 border-rose-300 border-2">
    <div id="container">
      <div id="thmbox"
        class="font-mono bg-yellow-200 leading-tight w-full h-full px-2 whitespace-pre overflow-auto text-green-800">
        &nbsp;
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js"></script>
  <script>
    const bg = (count) => (count & 1) === 0 ? "bg-rose-100" : ""; // "bg-rose-100";
    const seqToStr = (obj, doInsts) => {
      let repr = '<div class="flex flex-col max-w-xl whitespace-normal ml-2 bg-rose-50">';
      if (obj.name && obj.name.length > 0) {
        repr += `<div><span class="mb-3 text-rose-600 font-sans text-[.8em]">Subgoal ${obj.name}</span></div>`;
      }
      let count = 0;
      if (obj.vars && obj.vars.length > 0) {
        const vars = [], insts = [];
        obj.vars.forEach((v) => {
          if (v[1]) insts.push(v);
          else vars.push(v[0]);
        });
        if (vars.length)
          repr += `<div class="${bg(count++)}"><code>Variables: ${vars.join(" ")}</code></div>`;
        if (doInsts)
          insts.forEach((v) => {
            repr += `<div class="${bg(count++)}"><code>  ${v[0]} &larr; ${v[1]}</code></div>`;
          });
      }
      obj.hyps.forEach((h) => {
        repr += `<div class="${bg(count++)}"><code><span class="text-rose-600">${h[0]}</span>: ${h[1]}</code></div>`;
      });
      repr += `<div class="border-t-2 border-t-rose-600"></div>`;
      repr += `<div>&nbsp;<code>${obj.goal}</code></div>`;
      if (obj.more > 0)
        repr += `<div class="font-sans mt-1 text-[.8em]">(+ ${obj.more} more subgoal${obj.more > 1 ? "s" : ""})</div>`;
      repr += '</div>';
      return repr;
    }
    const getStuff = async () => {
      const init = {
        method: 'GET',
        cache: 'no-store',
        headers: { pragma: 'no-cache' }
      };
      let thm_text = await fetch('type-uniq.thm', init).then(resp => resp.text());
      let run_data = await fetch('type-uniq.json', init).then(resp => resp.json());
      const thm_box = $('#thmbox');
      thm_box.empty();
      let last_pos = 0;
      let cmd_map = new Map();
      run_data.forEach((elm) => {
        if (elm.range) {
          const [start, , , stop, ,] = elm.range;
          const chunk_div = $(`<div id="chunk-${elm.id}" class="inline">`);
          if (last_pos < start) {
            const space = $(`<span>${thm_text.slice(last_pos, start)}</span>`);
            $(chunk_div).append(space);
            last_pos = start;
          }
          const ul = elm.type === "proof_command" ? "text-rose-700 text-sm" : "leading-snug text-slate-800";
          const cmd = $(`<div class="abella-command inline-block ${ul} cursor-default hover:bg-rose-200/60">${thm_text.slice(start, stop)}</div>`);
          $(cmd).data('obj', elm);
          cmd_map.set(elm.id, cmd);
          $(chunk_div).append(cmd);
          last_pos = stop;
          $(thm_box).append(chunk_div);
        }
      });
      let thm_cmds = new Set();
      cmd_map.forEach((cmd, id) => {
        const obj = $(cmd).data('obj');
        if (obj && obj.type && obj.type == 'proof_command') {
          thm_cmds.add(obj.thm_id);
          const thm_cmd = cmd_map.get(obj.thm_id);
          $(thm_cmd).parent().append($(cmd).parent());
        }
      });
      thm_cmds.forEach((thm_id) => {
        const thm_cmd = cmd_map.get(thm_id);
        const btn = $('<button class="font-sans text-[.75em] text-green-700 hover:text-green-700/70 hover:underline">[collapse proof]</button>');
        $(btn).data('state', true);
        $(btn).click((ev) => {
          const cur_state = $(btn).data('state');
          $(btn).data('state', !cur_state);
          let cur = $(btn).next();
          while (cur.length) {
            if (cur_state) cur.hide()
            else cur.show();
            cur = cur.next();
          }
          $(btn).text(cur_state ? '[expand proof]' : '[collapse proof]');
        });
        $(thm_cmd).after(btn);
        $(thm_cmd).after('<span>\n</span>');
        // $(btn).click();
      });
      cmd_map.forEach((cmd, id) => {
        const obj = $(cmd).data('obj');
        let descr = "<div class=\"whitespace-pre font-mono text-sm overflow-auto\">";
        if (obj.type === "top_command") {
          descr += `Abella &lt; <strong>${$(cmd).text()}</strong>`;
        } else {
          descr += `${seqToStr(obj.start_state)}\n`;
          descr += `${obj.theorem} &lt; <strong>${$(cmd).text()}</strong>`;
          if (obj.end_state)
            descr += `\n\n${seqToStr(obj.end_state, obj.start_state.name === obj.end_state.name)}`;
          else
            descr += '\n\nProof completed.';
        }
        descr += "</div>";
        let flobj = $(`<div class="border-2 border-rose-800 bg-white p-2 shadow-lg shadow-rose-600/40">`);
        $(flobj).css({
          'position': 'absolute',
          'z-index': '10100',
          'display': 'none'
        });
        $(flobj).html(descr);
        $('#container').append(flobj);
        // setup the actions
        $(cmd).on("mousemove", function (ev) {
          const fl_width = $(flobj).outerWidth(true), fl_height = $(flobj).outerHeight(true);
          const w_width = $(window).width(), w_height = $(window).height();
          const p_x = ev.pageX, p_y = ev.pageY;
          const d = 10;
          const css = { display: 'block' };
          if (p_x + fl_width + d <= w_width) css.left = p_x + d;
          else css.left = w_width - fl_width;
          if (p_y + fl_height + d <= w_height) css.top = p_y + d;
          else if (p_y - fl_height - d >= 0) css.top = p_y - fl_height - d;
          else css.display = 'none'; // float doesn't fit above or below
          $(flobj).css(css);
        }).on("mouseleave", function () {
          $(flobj).css({ 'display': 'none' });
        }).on("click", function () {
          $(flobj).css({ 'display': 'none' });
          Fancybox.show([{ src: $(flobj).html(), type: "html" }]);
        });
      });
    }
    getStuff();
  </script>
</body>

</html>